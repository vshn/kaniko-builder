name: Push stable
on:
  push:
    paths:
      - .github/workflows/push-stable.yaml
  pull_request:
    paths:
      - .github/workflows/push-stable.yaml
  workflow_dispatch:
    inputs:
      push:
        type: boolean
        default: false
        description: Should the image be pushed

env:
  IMAGE: ghcr.io/${{ vars.IMAGE_PROJECT || 'vshn' }}/kaniko
  PUSH: ${{ inputs.push || startsWith(github.ref, 'refs/heads/main') }}

jobs:
  # the latest of the flavor debug is called debug
  retag-nightly-to-latest:
    runs-on: ubuntu-24.04
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: retag image
        run: |
          # renovate: datasource=docker depName=ghcr.io/vshn/kaniko
          TAG="nightly-debug@sha256:6e298d8ebf84200cfb430e38fd0a3d10d65d30b68461ea921888310eec957eae"

          docker pull ghcr.io/vshn/kaniko:$TAG
          docker tag ghcr.io/vshn/kaniko:$TAG ${{ env.IMAGE }}:debug
          if [ "${{ env.PUSH }}" = "true" ]; then
            docker push ${{ env.IMAGE }}:debug
          fi
